{% extends "layout_base.html" %}
{% block content %}
  <a href="/deposito/{{ deposito.codigo }}/fornecedor/{{ fornecedor }}">‚Üê Voltar</a>
  <h1>{{ fornecedor }} ‚Äî Caixa {{ caixa.numero }} (Dep√≥sito {{ deposito.codigo }})</h1>

  <h2>Produtos</h2>
  {% if caixa.produtos %}
    <table class="prod-table">
      <thead><tr><th>Imagem</th><th>Material</th><th>Nome</th><th>Defeito</th><th>Dep√≥sito</th><th>Total</th><th>Data</th><th>A√ß√µes</th></tr></thead>
      <tbody>
        {% for p in caixa.produtos %}
          <tr>
            <td>
              {% if p.imagem and p.imagem != 'sem imagem' %}
                <img src="{{ p.imagem }}" alt="Produto" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
              {% else %}
                <span style="color: #ccc; font-size: 12px;">-</span>
              {% endif %}
            </td>
            <td>{{ p.material }}</td>
            <td>{{ p.nome }}</td>
            <td>{{ p.defeito }}</td>
            <td>{{ p.deposito }}</td>
            <td>{{ p.total_pecas }}</td>
            <td>{{ p.data }}</td>
            <td>
              <form method="post" style="display:inline" onsubmit="return confirm('Confirma excluir esse produto?');">
                <input type="hidden" name="action" value="delete_product">
                <input type="hidden" name="prod_id" value="{{ p.id }}">
                <button type="submit" class="small danger">Excluir</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Esta caixa est√° vazia.</p>
  {% endif %}

  <h3>Adicionar Produto</h3>
  
  <!-- Preview da imagem -->
  <div id="imagemPreview" style="display: none; margin-bottom: 15px;">
    <img id="imagemProduto" src="" alt="Produto" style="max-width: 150px; max-height: 150px; border: 2px solid #ddd; border-radius: 8px; padding: 5px;">
    <p id="nomeProduto" style="margin-top: 8px; font-size: 14px; color: #666;"></p>
  </div>

  <form method="post" id="formProduto">
    <input type="hidden" name="action" value="add_product">
    <input type="hidden" name="ean" id="eanHidden">
    <input type="hidden" name="imagem" id="imagemHidden">
    
    <label>
      <strong>EAN (C√≥digo de Barras):</strong> 
      <input type="text" id="eanInput" placeholder="Bipe ou digite o EAN aqui" style="padding: 8px; width: 300px; font-size: 16px;">
      <span id="statusBusca" style="margin-left: 10px; font-weight: bold;"></span>
    </label>
    <br><br>

    <label>Material (c√≥digo interno): <input type="text" name="material" id="materialInput" readonly style="background: #f0f0f0;"></label><br>
    <label>Nome: <input type="text" name="nome" id="nomeInput"></label><br>
    <label>Defeito:
      <select name="defeito">
        {% for d in defects %}
          <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>
    </label><br>
    <label>Dep√≥sito:
      <select name="deposito">
        <option value="{{ deposito.codigo }}">{{ deposito.codigo }}</option>
        <option value="06">06</option>
        <option value="14">14</option>
      </select>
    </label><br>
    <label>Total de pe√ßas: <input type="text" name="total"></label><br>
    <label>Data (YYYY-MM-DD): <input type="text" name="data" value="{{ '' }}"></label><br>
    <button type="submit" style="background: #22c55e; color: white; padding: 10px 20px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer;">Adicionar</button>
  </form>

  <h3>Mesclar outras caixas nesta</h3>
  <form method="post">
    <input type="hidden" name="action" value="merge_boxes">
    {% for c in deposito.caixas %}
      {% if c.fornecedor == fornecedor and c.numero != caixa.numero %}
        <label><input type="checkbox" name="merge_ids" value="{{ c.numero }}"> Caixa {{ c.numero }}</label><br>
      {% endif %}
    {% endfor %}
    <button type="submit">Mesclar selecionadas</button>
  </form>

  <p><a href="/logout">Sair</a></p>

  <script>
    const eanInput = document.getElementById('eanInput');
    const materialInput = document.getElementById('materialInput');
    const nomeInput = document.getElementById('nomeInput');
    const statusBusca = document.getElementById('statusBusca');
    const imagemPreview = document.getElementById('imagemPreview');
    const imagemProduto = document.getElementById('imagemProduto');
    const nomeProduto = document.getElementById('nomeProduto');
    const formProduto = document.getElementById('formProduto');

    // APENAS busca quando pressionar Enter manualmente
    eanInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault(); // Previne o submit do formul√°rio
        const ean = this.value.trim();
        if (ean.length >= 8) {
          buscarPorEan(ean);
        } else {
          statusBusca.textContent = '‚ö†Ô∏è EAN muito curto';
          statusBusca.style.color = '#f59e0b';
        }
      }
    });

    function buscarPorEan(ean) {
      statusBusca.textContent = 'üîç Buscando...';
      statusBusca.style.color = '#3b82f6';
      
      const formData = new FormData();
      formData.append('ean', ean);
      
      fetch('/buscar_por_ean', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          statusBusca.textContent = '‚úÖ Encontrado!';
          statusBusca.style.color = '#22c55e';
          
          // Preenche os campos
          materialInput.value = data.codigo_interno;
          nomeInput.value = data.nome;
          
          // Salva EAN e imagem nos campos hidden
          document.getElementById('eanHidden').value = data.ean;
          document.getElementById('imagemHidden').value = data.imagem;
          
          // Mostra a imagem
          if (data.imagem && data.imagem !== 'sem imagem') {
            imagemProduto.src = data.imagem;
            nomeProduto.textContent = data.nome;
            imagemPreview.style.display = 'block';
          }
          
          // Foca no pr√≥ximo campo
          document.querySelector('select[name="defeito"]').focus();
        } else {
          statusBusca.textContent = '‚ùå ' + data.message;
          statusBusca.style.color = '#ef4444';
          materialInput.value = '';
          imagemPreview.style.display = 'none';
        }
      })
      .catch(err => {
        statusBusca.textContent = '‚ùå Erro na busca';
        statusBusca.style.color = '#ef4444';
        console.error(err);
      });
    }

    // Valida antes de enviar o formul√°rio
    formProduto.addEventListener('submit', function(e) {
      if (!materialInput.value) {
        e.preventDefault();
        alert('‚ùå Por favor, busque um produto pelo EAN antes de adicionar!');
        eanInput.focus();
        return false;
      }
    });
  </script>
{% endblock %}